---
title: "Migrating From the v1 Chat API to v2"
slug: "v2/docs/migrating-v1-to-v2"

hidden: true 
description: "The document serves as a reference for developers looking to update their existing Cohere API v1 implementations to the new v2 standard."
image: "../../../assets/images/b3c8253-cohere_meta_image.jpg"  
keywords: "Cohere, text generation, LLMs, generative AI"

createdAt: "Thu Feb 29 2024 18:13:25 GMT+0000 (Coordinated Universal Time)"
updatedAt: "Thu May 23 2024 04:32:10 GMT+0000 (Coordinated Universal Time)"
---
This guide serves as a reference for developers looking to update their existing Cohere API v1 implementations to the new v2 standard.

It outlines the key differences and necessary changes when migrating from Cohere API v1 to v2.

It covers various aspects of the API, including chat functionality, RAG (Retrieval-Augmented Generation), and tool use.

Each section provides code examples for both v1 and v2, highlighting the structural changes in request formats, response handling, and new features introduced in v2.


```python PYTHON
# ! pip install -U cohere

import json
import cohere

co_v1 = cohere.Client(api_key="<YOUR API KEY>")
co_v2 = cohere.ClientV2(api_key="<YOUR API KEY>")
```

# Chat

## Messages

- Message structure: 
   - v1: uses a combination of `preamble`, `message`, and `chat_history` parameters.
   - v2: uses a single `messages` parameter with a list of role-based dictionaries (`system`, `user`, `assistant`, or `tool`).

- Chat history:
   - v1: manages chat history internally via the `chat_history` parameter.
   - v2: manual management of the conversation in the `messages` list.

### v1

```python PYTHON
preamble = "You respond in concise sentences."

message_turn1 = "I'm joining a new startup called Co1t today. Could you help me write a one-sentence introduction message to my teammates."

res_turn1 = co_v1.chat(model="command-r-plus",
               preamble=preamble,
               message=message_turn1)

message_turn2 = "Make it shorter"

res_turn2 = co_v1.chat(model="command-r-plus",
                preamble=preamble,
                message=message_turn2,
                chat_history=res_turn1.chat_history)

for item in res_turn2.chat_history:
    print(item, "\n")
```

```
message="I'm joining a new startup called Co1t today. Could you help me write a one-sentence introduction message to my teammates." tool_calls=None role='USER' 

message='"Hi, I\'m [Your Name] and I\'m thrilled to join the Co1t team today as a [Your Role], eager to contribute my skills and ideas to the company\'s growth and success."' tool_calls=None role='CHATBOT' 

message='Make it shorter' tool_calls=None role='USER' 

message='"Excited to join Co1t today as a [Your Role] and looking forward to collaborating with the team."' tool_calls=None role='CHATBOT' 
```

### v2

```python PYTHON
preamble = """## Task and Context
You respond in concise sentences."""

message_turn1 = "I'm joining a new startup called Co1t today. Could you help me write a one-sentence introduction message to my teammates."

messages = [{'role': 'system', 'content': preamble},
           {'role': 'user', 'content': message_turn1}]

res_turn1 = co_v2.chat(model="command-r-plus",
                    messages=messages)

message_turn2 = "Make it shorter"

messages.extend([{'role': 'assistant', 'content': res_turn1.message.content[0].text},
                 {'role': 'user', 'content': message_turn2}])

res_turn2 = co_v2.chat(model="command-r-plus",
                          messages=messages)

messages.append({'role': 'assistant', 'content': res_turn2.message.content[0].text})

for message in messages:
    print(message, "\n")
```
```
{'role': 'system', 'content': '## Task and Context\nYou respond in concise sentences.'} 

{'role': 'user', 'content': "I'm joining a new startup called Co1t today. Could you help me write a one-sentence introduction message to my teammates."} 

{'role': 'assistant', 'content': '"Thrilled to join the Co1t team and looking forward to contributing my skills and ideas to drive innovation and success."'} 

{'role': 'user', 'content': 'Make it shorter'} 

{'role': 'assistant', 'content': '"Excited to join Co1t, ready to dive in and make an impact!"'} 
```  

## Response content

- Response content:
    - v1: `text`
    - v2: `message.content[0].text`

### v1

```python PYTHON
res = co_v1.chat(model="command-r-plus",
               message="What is 2 + 2")

print(res.text)
```
```
The answer is 4.
```

### v2

```python PYTHON
res = co_v2.chat(model="command-r-plus",
                 messages=[{'role': 'user', 'content': "What is 2 + 2"}])

print(res.message.content[0].text)
```
```
The answer is 4.
```

## Streaming

- Events containing content:
   - v1: `chunk.event_type == "text-generation"`
   - v2: `chunk.type == "content-delta"`

- Accessing response content:
   - v1: `chunk.text`
   - v2: `chunk.delta.message.content.text`

### v1

```python PYTHON
message = "I'm joining a new startup called Co1t today. Could you help me write a one-sentence introduction message to my teammates."

res = co_v1.chat_stream(model="command-r-plus",
                           message=message)

for chunk in res:
    if chunk.event_type == "text-generation":
        print(chunk.text, end="")
```
```
"Hi, I'm [your name] and I'm thrilled to join the Co1t team today as a [your role], eager to contribute my skills and ideas to help drive innovation and success for our startup!"
```

### v2

```python PYTHON
message = "I'm joining a new startup called Co1t today. Could you help me write a one-sentence introduction message to my teammates."

res = co_v2.chat_stream(model="command-r-plus",
                           messages=[{'role': 'user', 'content': message}])

for chunk in res: 
    if chunk:
        if chunk.type == "content-delta":
            print(chunk.delta.message.content.text, end="")
```
```
"Hi everyone, I'm thrilled to join the Co1t team today and look forward to contributing my skills and ideas to drive innovation and success!"
```

# RAG

## Documents

- Document handling
   - v1: uses separate `documents` parameter
   - v2: integrates `documents` as a field in the `user` role in `messages`

```python PYTHON
# Define the documents
documents = [
    {"text": "Reimbursing Travel Expenses: Easily manage your travel expenses by submitting them through our finance tool. Approvals are prompt and straightforward."},
    {"text": "Health and Wellness Benefits: We care about your well-being and offer gym memberships, on-site yoga classes, and comprehensive health insurance."}
]
```

### v1

```python PYTHON
message = "Are there fitness-related benefits?"

res_v1 = co_v1.chat(model="command-r-plus",
                    message=message,
                    documents=documents)

print(res_v1.text)
```
```
Yes, we offer gym memberships and on-site yoga classes as part of our health and wellness benefits.
```

### v2

```python PYTHON
message = "Are there fitness-related benefits?"

messages = [{'role': 'user', 'content': message, "documents": documents}]
    
res_v2 = co_v2.chat(model="command-r-plus",
                    messages=messages)

print(res_v2.message.content[0].text)
```
```
Yes, we offer gym memberships and on-site yoga classes as part of our health and wellness benefits.
```

## Search query generation

- Search query generation:
   - v1: Uses `search_queries_only` parameter
   - v2: No direct equivalent, alternative approaches available

### v1

```python PYTHON
res = co_v1.chat(model="command-r-plus",
              message="Google and Apple revenue 2023",
              search_queries_only=True)
```

### v2

The `search_queries_only` parameter is not supported in v2.

There are different possible approaches as alternatives. See the [RAG documentation](v2/docs/retrieval-augmented-generation-rag) for an example with a tool use approach.

## Citations

- Citations access:
   - v1: `citations`
   - v2: `message.citations`
- Cited documents access:
   - v1: `documents`
   - v2: as part of `message.citations`, in the `sources` field

### v1


```python PYTHON
print(res_v1.citations)
print(res_v1.documents)
```
```
[ChatCitation(start=14, end=29, text='gym memberships', document_ids=['doc_1']), ChatCitation(start=34, end=55, text='on-site yoga classes.', document_ids=['doc_1'])]

[{'id': 'doc_1', 'text': 'Health and Wellness Benefits: We care about your well-being and offer gym memberships, on-site yoga classes, and comprehensive health insurance.'}]
```

### v2


```python PYTHON
print(res_v2.message.citations)
```
```
[Citation(start=14, end=29, text='gym memberships', sources=[Source_Document(id='1', document={'id': '1', 'text': 'Health and Wellness Benefits: We care about your well-being and offer gym memberships, on-site yoga classes, and comprehensive health insurance.'}, type='document')]), Citation(start=34, end=54, text='on-site yoga classes', sources=[Source_Document(id='1', document={'id': '1', 'text': 'Health and Wellness Benefits: We care about your well-being and offer gym memberships, on-site yoga classes, and comprehensive health insurance.'}, type='document')]), Citation(start=70, end=99, text='health and wellness benefits.', sources=[Source_Document(id='1', document={'id': '1', 'text': 'Health and Wellness Benefits: We care about your well-being and offer gym memberships, on-site yoga classes, and comprehensive health insurance.'}, type='document')])]
```

## Streaming

- Event containing content:
   - v1: `chunk.event_type == "text-generation"`
   - v2: `chunk.type == "content-delta"`

- Accessing response content:
   - v1: `chunk.text`
   - v2: `chunk.delta.message.content.text`

- Events containing citations:
   - v1: `chunk.event_type == "citation-generation"`
   - v2: `chunk.type == "citation-start"`

- Accessing citations:
   - v1: `chunk.citations`
   - v2: `chunk.delta.message.citations`

### v1

```python PYTHON
message = "Are there fitness-related benefits?"

res_v1 = co_v1.chat_stream(model="command-r-plus",
                           message=message,
                           documents=documents)

for chunk in res_v1:
    if chunk.event_type == "text-generation":
        print(chunk.text, end="")
    if chunk.event_type == "citation-generation":
        print(f"\n{chunk.citations}")
```
```
Yes, we offer health and wellness benefits, including gym memberships and on-site yoga classes.

[ChatCitation(start=14, end=42, text='health and wellness benefits', document_ids=['doc_1'])]

[ChatCitation(start=54, end=69, text='gym memberships', document_ids=['doc_1'])]

[ChatCitation(start=74, end=95, text='on-site yoga classes.', document_ids=['doc_1'])]
```

### v2

```python PYTHON
message = "Are there fitness-related benefits?"

content = [{'type': 'text', 'text': message}]

for doc in documents:
    content.append({'type': 'document', 'document': doc})
    
messages = [{"role": "user", "content": content}]

res_v2 = co_v2.chat_stream(model="command-r-plus",
                           messages=messages)

for chunk in res_v2:
    if chunk:
        if chunk.type == "content-delta":
            print(chunk.delta.message.content.text, end="")
        if chunk.type == "citation-start":
            print(f"\n{chunk.delta.message.citations}")
```

```
Yes, we offer gym memberships and on-site yoga classes as part of our health and wellness benefits.

{'start': 14, 'end': 29, 'text': 'gym memberships', 'sources': [{'type': 'document', 'id': 'doc:0:1', 'document': {'id': 'doc:0:1', 'text': 'Health and Wellness Benefits: We care about your well-being and offer gym memberships, on-site yoga classes, and comprehensive health insurance.'}}]}

{'start': 34, 'end': 54, 'text': 'on-site yoga classes', 'sources': [{'type': 'document', 'id': 'doc:0:1', 'document': {'id': 'doc:0:1', 'text': 'Health and Wellness Benefits: We care about your well-being and offer gym memberships, on-site yoga classes, and comprehensive health insurance.'}}]}

{'start': 70, 'end': 99, 'text': 'health and wellness benefits.', 'sources': [{'type': 'document', 'id': 'doc:0:1', 'document': {'id': 'doc:0:1', 'text': 'Health and Wellness Benefits: We care about your well-being and offer gym memberships, on-site yoga classes, and comprehensive health insurance.'}}]}
```

# Tool use

## Tool definition

v2 format adheres more strictly to JSON Schema standards.

### v1

```python PYTHON
def get_weather(location):
    return {"temperature": "20C"}
  
functions_map = {"get_weather": get_weather}

tools_v1 = [
    {
      "name": "get_weather",
      "description": "Gets the weather of a given location",
      "parameter_definitions": {
        "location": {
          "description": "The location to get weather, example: San Francisco, CA",
          "type": "str",
          "required": True
        }
      }
    },
]
```

### v2

```python PYTHON
def get_weather(location):
    return {"temperature": "20C"}

functions_map = {"get_weather": get_weather}

tools_v2 = [
    {
    "type": "function",
    "function": {
            "name": "get_weather",
            "description" : "gets the weather of a given location",
            "parameters": {
                "type": "object",
                "properties": {
                "location": {
                    "type" : "str",
                    "description": "the location to get weather, example: San Fransisco, CA"
                }
                },
                "required": ["location"]
            }
            }
    },
]
```

## Tool calling

- Response handling
   - v1: Tool calls accessed through `res_v1.tool_calls`
   - v2: Tool calls accessed through `res_v2.message.tool_calls`

- Chat history management
   - v1: Tool calls stored in the response's `chat_history`
   - v2: Requires appending the tool call details (`tool_calls` and `tool_plan`) to the `messages` list

### v1

```python PYTHON
message = "What's the weather in Toronto?"

res_v1 = co_v1.chat(model="command-r-plus",
                    message=message,
                    tools=tools_v1)

print(res_v1.tool_calls)
```
```
[ToolCall(name='get_weather', parameters={'location': 'Toronto'})]
```

### v2

```python PYTHON
messages = [{'role': 'user', 'content': "What's the weather in Toronto?"}]

res_v2 = co_v2.chat(model="command-r-plus",
                    messages=messages,
                    tools=tools_v2)

if res_v2.message.tool_calls:
    messages.append({'role': 'assistant', 'tool_calls': res_v2.message.tool_calls, 'tool_plan': res_v2.message.tool_plan})
    
    print(res_v2.message.tool_calls)
```
```
[ToolCall2(id='get_weather_s8qdenha4v1z', type='function', function=ToolCall2Function(name='get_weather', arguments='{"location":"Toronto"}'))]
```

## Tool execution

- Function name access
   - v1: Access through `tc.name`
   - v2: Access through `tc.function.name`
   
- Function parameter access
   - v1: Access through `tc.parameters`
   - v2: Access through `tc.function.arguments`

- Chat history management
   - v1: Append `call` and `outputs` to the chat history
   - v2: Append `tool_call_id` and `tool_content` to `messages` to the chat history

### v1

```python PYTHON
tool_content_v1 = []
if res_v1.tool_calls:
    for tc in res_v1.tool_calls:
        tool_call = {"name": tc.name, "parameters": tc.parameters}
        tool_result = functions_map[tc.name](**tc.parameters)
        tool_content_v1.append({"call": tool_call, "outputs": [tool_result]})
        
print(tool_content_v1)
```
```
[{'call': {'name': 'get_weather', 'parameters': {'location': 'Toronto'}}, 'outputs': [{'temperature': '20C'}]}]
```

### v2

```python PYTHON
tool_content_v2 = []
if res_v2.message.tool_calls:
    for tc in res_v2.message.tool_calls:
        tool_result = functions_map[tc.function.name](**json.loads(tc.function.arguments))
        tool_content_v2.append(cohere.ToolContent(output=tool_result))
        messages.append({'role': 'tool', 'tool_call_id': tc.id, 'tool_content': tool_content_v2})
        
print(tool_content_v2)
```
```
[ToolContent(output={'temperature': '20C'})]
```

## Response generation

- User message
    - v1: Set as empty (`""`)
    - v2: No action required
- Tool results
    - v1: Passed as `tool_results` parameter
    - v2: Incorporated into the `messages` list as tool responses

### v1

```python PYTHON
res_v1 = co_v1.chat(
    model="command-r-plus",
    message="",
    tools=tools_v1,
    tool_results=tool_content_v1,   
    chat_history=res_v1.chat_history
)

print(res_v1.text)
```
```
It's 20°C in Toronto.
```

### v2

```python PYTHON
res_v2 = co_v2.chat(
    model="command-r-plus",
    messages=messages,
    tools=tools_v2
)

print(res_v2.message.content[0].text)
```
```
It's 20°C in Toronto.
```

## Citations

- Citations access:
   - v1: `citations`
   - v2: `message.citations`
- Cited tools access:
   - v1: `documents`
   - v2: as part of `message.citations`, in the `sources` field

### v1

```python PYTHON
print(res_v1.citations)
print(res_v1.documents)
```
```
[ChatCitation(start=5, end=9, text='20°C', document_ids=['get_weather:0:2:0'])]

[{'id': 'get_weather:0:2:0', 'temperature': '20C', 'tool_name': 'get_weather'}]
```

### v2

```python PYTHON
print(res_v2.message.citations)
```
```
[Citation(start=5, end=9, text='20°C', sources=[Source_Tool(id='get_weather_qdrnx4myss0f:0', tool_output={'temperature': '20C'}, type='tool')])]
```

## Streaming

- Event containing content:
   - v1: `chunk.event_type == "text-generation"`
   - v2: `chunk.type == "content-delta"`

- Accessing response content:
   - v1: `chunk.text`
   - v2: `chunk.delta.message.content.text`

- Events containing citations:
   - v1: `chunk.event_type == "citation-generation"`
   - v2: `chunk.type == "citation-start"`

- Accessing citations:
   - v1: `chunk.citations`
   - v2: `chunk.delta.message.citations`

### v1

```python PYTHON
res_v1 = co_v1.chat_stream(
    message="",
    tools=tools_v1,
    tool_results=tool_content_v1,
    chat_history=res_v1.chat_history
)

for chunk in res_v1:
    if chunk.event_type == "text-generation":
        print(chunk.text, end="")
    if chunk.event_type == "citation-generation":
        print(f"\n{chunk.citations}")
```
```
It's currently 20°C in Toronto.

[ChatCitation(start=15, end=19, text='20°C', document_ids=['get_weather:0:2:0', 'get_weather:0:4:0'])]
```

### v2

```python PYTHON
res_v2 = co_v2.chat_stream(
    model="command-r-plus",
    messages=messages,
    tools=tools_v2
)

for chunk in res_v2:
    if chunk:
        if chunk.type == "content-delta":
            print(chunk.delta.message.content.text, end="")
        elif chunk.type == "citation-start":
            print(f"\n{chunk.delta.message.citations}")
```
```
It's 20°C in Toronto.

{'start': 5, 'end': 9, 'text': '20°C', 'sources': [{'type': 'tool', 'id': 'get_weather_jmw7pa5s1rjq:0', 'tool_output': {'temperature': '20C'}}]}
```

# Unsupported features

The following v1 features are not supported in v2:
- General chat
    - `preamble` parameter (replaced by `system` role in `messages`)
    - `conversation_id` parameter (chat history is now managed by the developer in `messages`)
- RAG
    - `search_queries_only` parameter
    - `connectors` parameter
    - `prompt_truncation` parameter
    - `citation_quality` (replaced by `citation_mode` with the same functionality)
- Tool use
    - `force_single_step` parameter (all tool calls are now multi-step by default)
    - `tool_results` parameter (replaced by `tool` role in `messages`)
    - `citation_quality` (replaced by `citation_mode` with the same functionality)