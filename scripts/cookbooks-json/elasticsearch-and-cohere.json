{
  "custompage": {
    "metadata": {
      "image": [],
      "title": "",
      "description": "",
      "keywords": ""
    },
    "algolia": {
      "recordCount": 7,
      "publishPending": false,
      "updatedAt": "2024-07-11T01:20:26.963Z"
    },
    "title": "End-to-end RAG using Elasticsearch and Cohere",
    "slug": "elasticsearch-and-cohere",
    "body": "[block:html]\n{\n  \"html\": \"<div class=\\\"cookbook-nav-container\\\">\\n  <a href=\\\"/page/cookbooks\\\" class=\\\"back-button pt-10 group inline-block cursor-pointer font-medium \\\" rel=\\\"noreferrer\\\"\\n    target=\\\"_self\\\">\\n    <div class=\\\"pr-1 inline-block group-hover:no-underline\\\">\\n      <svg width=\\\"11.8\\\" height=\\\"11\\\" viewBox=\\\"0 0 14 13\\\" fill=\\\"none\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\">\\n        <path\\n          d=\\\"M1.1554 7.20808C1.35066 7.40335 1.66724 7.40335 1.8625 7.20808L7.18477 1.88582C7.38003 1.69055 7.38003 1.37397 7.18477 1.17871L6.83121 0.825157C6.63595 0.629895 6.31937 0.629896 6.12411 0.825157L0.801842 6.14742C0.60658 6.34269 0.60658 6.65927 0.801842 6.85453L1.1554 7.20808Z\\\"\\n          fill=\\\"currentColor\\\" />\\n        <path\\n          d=\\\"M1.1554 5.79226C1.35066 5.597 1.66724 5.597 1.8625 5.79226L7.18477 11.1145C7.38003 11.3098 7.38003 11.6264 7.18477 11.8216L6.83121 12.1752C6.63595 12.3705 6.31937 12.3705 6.12411 12.1752L0.801842 6.85292C0.60658 6.65766 0.60658 6.34108 0.801842 6.14582L1.1554 5.79226Z\\\"\\n          fill=\\\"currentColor\\\" />\\n        <path\\n          d=\\\"M2.52491 6.23674C2.52492 5.9606 2.74878 5.73675 3.02491 5.73675H6.28412C6.4513 5.73675 6.60742 5.8203 6.70015 5.95941L7.03347 6.45941C7.25499 6.79169 7.01679 7.23675 6.61745 7.23675H3.0249C2.74876 7.23675 2.5249 7.01289 2.5249 6.73674L2.52491 6.23674Z\\\"\\n          fill=\\\"currentColor\\\" />\\n        <path\\n          d=\\\"M13.5517 6.73676C13.5517 7.0129 13.3278 7.23675 13.0517 7.23675H8.79246C8.62528 7.23675 8.46916 7.1532 8.37643 7.0141L8.04311 6.5141C7.8216 6.18182 8.05979 5.73675 8.45914 5.73675H13.0517C13.3278 5.73675 13.5517 5.96062 13.5517 6.23676L13.5517 6.73676Z\\\"\\n          fill=\\\"currentColor\\\" />\\n      </svg>\\n    </div>\\n    Back to Cookbooks\\n  </a>\\n\\n  <a href=https://github.com/cohere-ai/cohere-developer-experience/blob/main/notebooks/Cohere_Elastic_Guide.ipynb class=\\\"github-button pt-10 group inline-block cursor-pointer font-medium \\\" rel=\\\"noreferrer\\\"\\n    target=\\\"_blank\\\">\\n    Open in GitHub\\n    <div class=\\\"pl-1 inline-block group-hover:no-underline\\\">\\n      <svg width=\\\"14\\\" height=\\\"10\\\" viewBox=\\\"0 0 14 10\\\" fill=\\\"none\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\">\\n        <path\\n          d=\\\"M8.63218 0.366821C8.35604 0.366821 8.13218 0.590679 8.13218 0.866821V8.39364C8.13218 8.66978 8.35604 8.89364 8.63218 8.89364H9.13218C9.40832 8.89364 9.63218 8.66978 9.63218 8.39364V0.866821C9.63218 0.590678 9.40832 0.366821 9.13218 0.366821H8.63218Z\\\"\\n          fill=\\\"currentColor\\\" />\\n        <path\\n          d=\\\"M9.63332 1.36796C9.63332 1.6441 9.40946 1.86796 9.13332 1.86796H1.6065C1.33035 1.86796 1.1065 1.6441 1.1065 1.36796V0.867956C1.1065 0.591813 1.33035 0.367956 1.6065 0.367956H9.13332C9.40946 0.367956 9.63332 0.591813 9.63332 0.867956V1.36796Z\\\"\\n          fill=\\\"currentColor\\\" />\\n        <path\\n          d=\\\"M8.35063 2.02206C8.54588 2.21732 8.54588 2.5339 8.35062 2.72916L6.04601 5.03377C5.9278 5.15198 5.75833 5.20329 5.59439 5.1705L5.00515 5.05264C4.61356 4.97432 4.46728 4.49118 4.74966 4.2088L7.28997 1.66849C7.48523 1.47323 7.80182 1.47323 7.99708 1.6685L8.35063 2.02206Z\\\"\\n          fill=\\\"currentColor\\\" />\\n        <path\\n          d=\\\"M0.199967 9.46558C0.0047119 9.27032 0.0047151 8.95374 0.199974 8.75848L3.21169 5.74677C3.3299 5.62855 3.49938 5.57724 3.66331 5.61003L4.25256 5.72789C4.64414 5.80621 4.79042 6.28935 4.50804 6.57173L1.26063 9.81915C1.06536 10.0144 0.748774 10.0144 0.553513 9.81914L0.199967 9.46558Z\\\"\\n          fill=\\\"currentColor\\\" />\\n      </svg>\\n    </div>\\n  </a>\\n</div>\\n\\n<div>\\n  <h1>End-to-end RAG using Elasticsearch and Cohere</h1>\\n</div>\\n\\n<style>\\n  .header {\\n    padding: 9px 0 17px 0;\\n    display: flex;\\n    flex-direction: column;\\n  }\\n\\n  a[href],\\n  .field-description a:not([href=\\\"\\\"]),\\n  .markdown-body a[href],\\n  .markdown-body a:not([href=\\\"\\\"]) {\\n    text-decoration: none;\\n  }\\n\\n  #content {\\n    padding: 0 32px;\\n  }\\n\\n  #content-head {\\n    display: none;\\n  }\\n\\n  .guide-page-title {\\n    font-size: 29px !important;\\n  }\\n\\n  .back-button .github-button {\\n    border-radius: 0 !important;\\n    border-width: 0 !important;\\n    background-color: inherit !important;\\n  }\\n\\n  .cookbook-nav-container {\\n    display: flex;\\n    flex-direction: row;\\n    justify-content: space-between;\\n    align-items: center;\\n  }\\n\\n  @media only screen and (min-width: 620px) {\\n    .guide-page-title {\\n      width: 70%;\\n    }\\n\\n    .header {\\n      display: flex;\\n      flex-direction: row;\\n      align-items: center;\\n      justify-content: space-between;\\n      padding: 9px 0 17px 0;\\n    }\\n\\n    .git--button {\\n      width: 145px !important;\\n      display: flex;\\n      flex-direction: row;\\n      justify-content: center;\\n      align-items: center;\\n      padding: 8px 16px;\\n\\n      width: 154px;\\n      height: 35px;\\n\\n      background: #D4D9D4;\\n      border: 1px solid #9DAAA4;\\n      border-radius: 6px;\\n    }\\n  }\\n\\n\\n  @media only screen and (min-width: 1024px) {\\n    .guide-page-title {\\n      font-size: 46px !important;\\n    }\\n\\n    .header {\\n      padding: 9px 0 32px 0;\\n    }\\n  }\\n</style>\"\n}\n[/block]\n\n\nLearn how to use the [Inference API](https://www.elastic.co/guide/en/elasticsearch/reference/current/inference-apis.html) for semantic search and use [Cohere's APIs](https://docs.cohere.com/docs/the-cohere-platform) for RAG.\n\n\nFor this example, you will need:\n\n- An Elastic Serverless account through [Elastic Cloud](https://www.elastic.co/guide/en/cloud/current/ec-getting-started.html), available with a [free trial](https://cloud.elastic.co/registration?utm_source=github&utm_content=elasticsearch-labs-notebook)\n   \n- A [Cohere account](https://cohere.com/) with a production API key\n\n- Python 3.7 or higher\n\nNote: While this tutorial integrates Cohere with an Elastic Cloud serverless project, you can also integrate with your self-managed Elasticsearch deployment or Elastic Cloud deployment by simply switching from using a Serverless endpoint in the Elasticsearch client.\n\n\nIf you don't have an Elastic Cloud deployment, sign up [here](https://cloud.elastic.co/registration?utm_source=github&utm_content=elasticsearch-labs-notebook) for a free trial and request access to Elastic Serverless\n\n\nTo get started, we'll need to connect to our Elastic Serverless deployment using the Python client.\n\nFirst we need to `pip` install the following packages:\n\n- `elasticsearch_serverless`\n- `cohere`\n\nAfter installing, in the Serverless dashboard, find your endpoint URL, and create your API key.\n\n\n```python\npip install elasticsearch_serverless cohere\n```\n\nNext, we need to import the modules we need. üîê NOTE: getpass enables us to securely prompt the user for credentials without echoing them to the terminal, or storing it in memory.\n\n\n```python\nfrom elasticsearch_serverless import Elasticsearch, helpers\nfrom getpass import getpass\nimport cohere\nimport json\nimport requests\n```\n\n\n\nNow we can instantiate the Python Elasticsearch client.\n\nFirst we prompt the user for their endpoint and encoded API key.\nThen we create a `client` object that instantiates an instance of the `Elasticsearch` class.\n\nWhen creating your Elastic Serverless API key make sure to turn on Control security privileges, and edit cluster privileges to specify `\"cluster\": [\"all\"]`\n\n\n```python\nELASTICSEARCH_ENDPOINT = getpass(\"Elastic Endpoint: \")\nELASTIC_API_KEY = getpass(\"Elastic encoded API key: \") # Use the encoded API key\n\nclient = Elasticsearch(\n  ELASTICSEARCH_ENDPOINT,\n  api_key=ELASTIC_API_KEY\n)\n```\n\nConfirm that the client has connected with this test:\n\n\n```python\nprint(client.info())\n```\n\n## Create the inference endpoint\n\nLet's create the inference endpoint by using the [Create inference API](https://www.elastic.co/guide/en/elasticsearch/reference/current/put-inference-api.html).\n\nYou'll need an Cohere API key for this that you can find in your Cohere account under the [API keys section](https://dashboard.cohere.com/api-keys). A production key is required to complete the steps in this notebook as the Cohere free trial API usage is limited.\n\n\n\n\n```python\nCOHERE_API_KEY = getpass(\"Enter Cohere API key:  \")\n\nclient.options(ignore_status=[404]).inference.delete_model(inference_id=\"cohere_embeddings\")\n\nclient.inference.put_model(\n    task_type=\"text_embedding\",\n    inference_id=\"cohere_embeddings\",\n    body={\n        \"service\": \"cohere\",\n        \"service_settings\": {\n            \"api_key\": COHERE_API_KEY,\n            \"model_id\": \"embed-english-v3.0\",\n            \"embedding_type\": \"int8\",\n            \"similarity\": \"cosine\"\n        },\n        \"task_settings\": {},\n    },\n)\n```\n\n## Create an ingest pipeline with an inference processor\n\nCreate an ingest pipeline with an inference processor by using the [`put_pipeline`](https://www.elastic.co/guide/en/elasticsearch/reference/master/put-pipeline-api.html) method. Reference the inference endpoint created above as the `model_id` to infer against the data that is being ingested in the pipeline.\n\n\n```python\nclient.options(ignore_status=[404]).ingest.delete_pipeline(id=\"cohere_embeddings\")\n\nclient.ingest.put_pipeline(\n    id=\"cohere_embeddings\",\n    description=\"Ingest pipeline for Cohere inference.\",\n    processors=[\n        {\n            \"inference\": {\n                \"model_id\": \"cohere_embeddings\",\n                \"input_output\": {\n                    \"input_field\": \"text\",\n                    \"output_field\": \"text_embedding\",\n                },\n            }\n        }\n    ],\n)\n```\n\nLet's note a few important parameters from that API call:\n\n- `inference`: A processor that performs inference using a machine learning model.\n- `model_id`: Specifies the ID of the inference endpoint to be used. In this example, the model ID is set to `cohere_embeddings`.\n- `input_output`: Specifies input and output fields.\n- `input_field`: Field name from which the `dense_vector` representation is created.\n- `output_field`:  Field name which contains inference results.\n\n## Create index\n\nThe mapping of the destination index ‚Äì the index that contains the embeddings that the model will create based on your input text ‚Äì must be created. The destination index must have a field with the [dense_vector](https://www.elastic.co/guide/en/elasticsearch/reference/current/dense-vector.html) field type to index the output of the Cohere model.\n\nLet's create an index named `cohere-wiki-embeddings` with the mappings we need.\n\n\n```python\nclient.indices.delete(index=\"cohere-wiki-embeddings\", ignore_unavailable=True)\nclient.indices.create(\n    index=\"cohere-wiki-embeddings\",\n    settings={\"index\": {\"default_pipeline\": \"cohere_embeddings\"}},\n    mappings={\n        \"properties\": {\n            \"text_embedding\": {\n                \"type\": \"dense_vector\",\n                \"dims\": 1024,\n                \"element_type\": \"byte\"\n            },\n            \"text\": {\"type\": \"text\"},\n            \"wiki_id\": {\"type\": \"integer\"},\n            \"url\": {\"type\": \"text\"},\n            \"views\": {\"type\": \"float\"},\n            \"langs\": {\"type\": \"integer\"},\n            \"title\": {\"type\": \"text\"},\n            \"paragraph_id\": {\"type\": \"integer\"},\n            \"id\": {\"type\": \"integer\"}\n        }\n    },\n)\n```\n\n## Insert Documents\n\nLet's insert our example wiki dataset. You need a production Cohere account to complete this step, otherwise the documentation ingest will time out due to the API request rate limits.\n\n\n```python\nurl = \"https://raw.githubusercontent.com/cohere-ai/cohere-developer-experience/main/notebooks/data/embed_jobs_sample_data.jsonl\"\nresponse = requests.get(url)\n\njsonl_data = response.content.decode('utf-8').splitlines()\n\ndocuments = []\nfor line in jsonl_data:\n    data_dict = json.loads(line)\n    documents.append({\n        \"_index\": \"cohere-wiki-embeddings\",\n        \"_source\": data_dict,\n        }\n      )\n\nhelpers.bulk(client, documents)\n\nprint(\"Done indexing documents into `cohere-wiki-embeddings` index!\")\n```\n\n## Hybrid search\n\nAfter the dataset has been enriched with the embeddings, you can query the data using hybrid search.\n\nPass a `query_vector_builder` to the k-nearest neighbor (kNN) vector search API, and provide the query text and the model you have used to create the embeddings.\n\n\n```python\nquery = \"When were the semi-finals of the 2022 FIFA world cup played?\"\n\nresponse = client.search(\n    index=\"cohere-wiki-embeddings\",\n    size=100,\n    knn={\n        \"field\": \"text_embedding\",\n        \"query_vector_builder\": {\n            \"text_embedding\": {\n                \"model_id\": \"cohere_embeddings\",\n                \"model_text\": query,\n            }\n        },\n        \"k\": 10,\n        \"num_candidates\": 50,\n    },\n    query={\n      \"multi_match\": {\n          \"query\": query,\n          \"fields\": [\"text\", \"title\"]\n        }\n      }\n)\n\nraw_documents = response[\"hits\"][\"hits\"]\n\nfor document in raw_documents[0:10]:\n  print(f'Title: {document[\"_source\"][\"title\"]}\\nText: {document[\"_source\"][\"text\"]}\\n')\n\ndocuments = []\nfor hit in response[\"hits\"][\"hits\"]:\n    documents.append(hit[\"_source\"][\"text\"])\n```\n\n## Ranking\nIn order to effectively combine the results from our vector and BM25 retrieval, we can use Cohere's Rerank 3 model through the inference API to provide a final, more precise, semantic reranking of our results.\n\nFirst, create an inference endpoint with your Cohere API key. Make sure to specify a name for your endpoint, and the model_id of one of the rerank models. In this example we will use Rerank 3.\n\n\n```python\nclient.options(ignore_status=[404]).inference.delete_model(inference_id=\"cohere_rerank\")\n\nclient.inference.put_model(\n    task_type=\"rerank\",\n    inference_id=\"cohere_rerank\",\n    body={\n        \"service\": \"cohere\",\n        \"service_settings\":{\n            \"api_key\": COHERE_API_KEY,\n            \"model_id\": \"rerank-english-v3.0\"\n           },\n        \"task_settings\": {\n            \"top_n\": 10,\n        },\n    }\n)\n```\n\nYou can now rerank your results using that inference endpoint. Here we will pass in the query we used for retrieval, along with the documents we just retrieved using hybrid search.\n\nThe inference service will respond with a list of documents in descending order of relevance. Each document has a corresponding index (reflecting to the order the documents were in when sent to the inference endpoint), and if the ‚Äúreturn_documents‚Äù task setting is True, then the document texts will be included as well.\n\nIn this case we will set the response to False and will reconstruct the input documents based on the index returned in the response.\n\n\n```python\nresponse = client.inference.inference(\n    inference_id=\"cohere_rerank\",\n    body={\n        \"query\": query,\n        \"input\": documents,\n        \"task_settings\": {\n            \"return_documents\": False\n            }\n        }\n)\n\nranked_documents = []\nfor document in response.body[\"rerank\"]:\n  ranked_documents.append({\n      \"title\": raw_documents[int(document[\"index\"])][\"_source\"][\"title\"],\n      \"text\": raw_documents[int(document[\"index\"])][\"_source\"][\"text\"]\n  })\n\nfor document in ranked_documents[0:10]:\n  print(f\"Title: {document['title']}\\nText: {document['text']}\\n\")\n```\n\n\nNow that we have ranked our results, we can easily turn this into a RAG system with Cohere's Chat API. Pass in the retrieved documents, along with the query and see the grounded response using Cohere's newest generative model Command R+.\n\nFirst, we will create the Cohere client.\n\n\n```python\nco = cohere.Client(COHERE_API_KEY)\n```\n\nNext, we can easily get a grounded generation with citations from the Cohere Chat API. We simply pass in the user query and documents retrieved from Elastic to the API, and print out our grounded response.\n\n\n```python\nresponse = co.chat(\n    message=query,\n    documents=ranked_documents,\n    model='command-r-plus'\n)\n\nsource_documents = []\nfor citation in response.citations:\n  for document_id in citation.document_ids:\n    if document_id not in source_documents:\n      source_documents.append(document_id)\n\nprint(f\"Query: {query}\")\nprint(f\"Response: {response.text}\")\nprint(\"Sources:\")\nfor document in response.documents:\n  if document['id'] in source_documents:\n    print(f\"{document['title']}: {document['text']}\")\n```\n\nAnd there you have it! A quick and easy implementation of hybrid search and RAG with Cohere and Elastic.",
    "html": "",
    "htmlmode": false,
    "fullscreen": false,
    "hidden": true,
    "revision": 5,
    "_id": "664dc8e90cae9b006d4ae1c8",
    "__v": 0,
    "createdAt": "2024-05-22T10:28:57.804Z",
    "lastUpdatedHash": "843d4ae030caa4d4ac561c636a8c18bb5c0a668d",
    "project": "62cde2919aafea009aefb289",
    "updatedAt": "2024-07-11T01:20:26.964Z",
    "user": "5af39863989da435b05d284d"
  },
  "meta": {
    "user": {
      "allowedProjects": ["cohere-ai", "cohere-enterprise"],
      "apiKey": "",
      "email": "andrewjiang@hey.com",
      "name": "Andrew Jiang",
      "version": 1,
      "Name": "Andrew Jiang",
      "Email": "andrewjiang@hey.com",
      "APIKey": "",
      "AllowedProjects": ["cohere-ai", "cohere-enterprise"]
    },
    "baseUrl": "/",
    "hidden": true,
    "title": "End-to-end RAG using Elasticsearch and Cohere",
    "metaTitle": "End-to-end RAG using Elasticsearch and Cohere",
    "keywords": "",
    "description": "",
    "image": [],
    "slug": "elasticsearch-and-cohere",
    "type": "custompage",
    "full": false
  }
}
