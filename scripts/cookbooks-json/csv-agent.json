{
  "custompage": {
    "metadata": {
      "image": [],
      "title": "",
      "description": "",
      "keywords": ""
    },
    "algolia": {
      "recordCount": 12,
      "publishPending": false,
      "updatedAt": "2024-07-11T01:20:29.397Z"
    },
    "title": "Financial CSV Agent with Langchain",
    "slug": "csv-agent",
    "body": "[block:html]\n{\n  \"html\": \"<div class=\\\"cookbook-nav-container\\\">\\n  <a href=\\\"/page/cookbooks\\\" class=\\\"back-button pt-10 group inline-block cursor-pointer font-medium \\\" rel=\\\"noreferrer\\\"\\n    target=\\\"_self\\\">\\n    <div class=\\\"pr-1 inline-block group-hover:no-underline\\\">\\n      <svg width=\\\"11.8\\\" height=\\\"11\\\" viewBox=\\\"0 0 14 13\\\" fill=\\\"none\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\">\\n        <path\\n          d=\\\"M1.1554 7.20808C1.35066 7.40335 1.66724 7.40335 1.8625 7.20808L7.18477 1.88582C7.38003 1.69055 7.38003 1.37397 7.18477 1.17871L6.83121 0.825157C6.63595 0.629895 6.31937 0.629896 6.12411 0.825157L0.801842 6.14742C0.60658 6.34269 0.60658 6.65927 0.801842 6.85453L1.1554 7.20808Z\\\"\\n          fill=\\\"currentColor\\\" />\\n        <path\\n          d=\\\"M1.1554 5.79226C1.35066 5.597 1.66724 5.597 1.8625 5.79226L7.18477 11.1145C7.38003 11.3098 7.38003 11.6264 7.18477 11.8216L6.83121 12.1752C6.63595 12.3705 6.31937 12.3705 6.12411 12.1752L0.801842 6.85292C0.60658 6.65766 0.60658 6.34108 0.801842 6.14582L1.1554 5.79226Z\\\"\\n          fill=\\\"currentColor\\\" />\\n        <path\\n          d=\\\"M2.52491 6.23674C2.52492 5.9606 2.74878 5.73675 3.02491 5.73675H6.28412C6.4513 5.73675 6.60742 5.8203 6.70015 5.95941L7.03347 6.45941C7.25499 6.79169 7.01679 7.23675 6.61745 7.23675H3.0249C2.74876 7.23675 2.5249 7.01289 2.5249 6.73674L2.52491 6.23674Z\\\"\\n          fill=\\\"currentColor\\\" />\\n        <path\\n          d=\\\"M13.5517 6.73676C13.5517 7.0129 13.3278 7.23675 13.0517 7.23675H8.79246C8.62528 7.23675 8.46916 7.1532 8.37643 7.0141L8.04311 6.5141C7.8216 6.18182 8.05979 5.73675 8.45914 5.73675H13.0517C13.3278 5.73675 13.5517 5.96062 13.5517 6.23676L13.5517 6.73676Z\\\"\\n          fill=\\\"currentColor\\\" />\\n      </svg>\\n    </div>\\n    Back to Cookbooks\\n  </a>\\n\\n  <a href=https://github.com/cohere-ai/cohere-developer-experience/blob/main/notebooks/agents/financial-csv-agent/financial_csv_publication.ipynb class=\\\"github-button pt-10 group inline-block cursor-pointer font-medium \\\" rel=\\\"noreferrer\\\"\\n    target=\\\"_blank\\\">\\n    Open in GitHub\\n    <div class=\\\"pl-1 inline-block group-hover:no-underline\\\">\\n      <svg width=\\\"14\\\" height=\\\"10\\\" viewBox=\\\"0 0 14 10\\\" fill=\\\"none\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\">\\n        <path\\n          d=\\\"M8.63218 0.366821C8.35604 0.366821 8.13218 0.590679 8.13218 0.866821V8.39364C8.13218 8.66978 8.35604 8.89364 8.63218 8.89364H9.13218C9.40832 8.89364 9.63218 8.66978 9.63218 8.39364V0.866821C9.63218 0.590678 9.40832 0.366821 9.13218 0.366821H8.63218Z\\\"\\n          fill=\\\"currentColor\\\" />\\n        <path\\n          d=\\\"M9.63332 1.36796C9.63332 1.6441 9.40946 1.86796 9.13332 1.86796H1.6065C1.33035 1.86796 1.1065 1.6441 1.1065 1.36796V0.867956C1.1065 0.591813 1.33035 0.367956 1.6065 0.367956H9.13332C9.40946 0.367956 9.63332 0.591813 9.63332 0.867956V1.36796Z\\\"\\n          fill=\\\"currentColor\\\" />\\n        <path\\n          d=\\\"M8.35063 2.02206C8.54588 2.21732 8.54588 2.5339 8.35062 2.72916L6.04601 5.03377C5.9278 5.15198 5.75833 5.20329 5.59439 5.1705L5.00515 5.05264C4.61356 4.97432 4.46728 4.49118 4.74966 4.2088L7.28997 1.66849C7.48523 1.47323 7.80182 1.47323 7.99708 1.6685L8.35063 2.02206Z\\\"\\n          fill=\\\"currentColor\\\" />\\n        <path\\n          d=\\\"M0.199967 9.46558C0.0047119 9.27032 0.0047151 8.95374 0.199974 8.75848L3.21169 5.74677C3.3299 5.62855 3.49938 5.57724 3.66331 5.61003L4.25256 5.72789C4.64414 5.80621 4.79042 6.28935 4.50804 6.57173L1.26063 9.81915C1.06536 10.0144 0.748774 10.0144 0.553513 9.81914L0.199967 9.46558Z\\\"\\n          fill=\\\"currentColor\\\" />\\n      </svg>\\n    </div>\\n  </a>\\n</div>\\n\\n<div>\\n  <h1>Financial CSV Agent with Langchain</h1>\\n</div>\\n\\n<!-- Authors -->\\n<div class=\\\"authors-container\\\">\\n  \\n  <div class=\\\"author-container\\\">\\n    <img class=\\\"author-image\\\" src=\\\"https://files.readme.io/d17fc44-Shaan.jpg\\\" alt=\\\"Shaan Desai\\\" />\\n    <p class=\\\"author-name\\\">Shaan Desai</p>\\n  </div>\\n  \\n</div>\\n\\n<style>\\n  .header {\\n    padding: 9px 0 17px 0;\\n    display: flex;\\n    flex-direction: column;\\n  }\\n\\n  a[href],\\n  .field-description a:not([href=\\\"\\\"]),\\n  .markdown-body a[href],\\n  .markdown-body a:not([href=\\\"\\\"]) {\\n    text-decoration: none;\\n  }\\n\\n  #content {\\n    padding: 0 32px;\\n  }\\n\\n  #content-head {\\n    display: none;\\n  }\\n\\n  .guide-page-title {\\n    font-size: 29px !important;\\n  }\\n\\n  .back-button .github-button {\\n    border-radius: 0 !important;\\n    border-width: 0 !important;\\n    background-color: inherit !important;\\n  }\\n\\n  .cookbook-nav-container {\\n    display: flex;\\n    flex-direction: row;\\n    justify-content: space-between;\\n    align-items: center;\\n  }\\n\\n  .authors-container {\\n    display: flex;\\n    flex-direction: row;\\n    flex-flow: row wrap;\\n    gap: 2px 14px;\\n    margin-top: 8px;\\n  }\\n\\n  .author-container {\\n    line-height: 1.5em;\\n    display: flex;\\n    flex-direction: row;\\n    vertical-align: middle;\\n    flex-shrink: 0;\\n  }\\n\\n  .author-image {\\n    height: 1.5em;\\n    margin: 0px 6px 6px 0px !important;\\n    border-radius: 50%;\\n  }\\n\\n  .author-name {\\n    white-space: nowrap;\\n    vertical-align: middle;\\n  }\\n\\n  @media only screen and (min-width: 620px) {\\n    .guide-page-title {\\n      width: 70%;\\n    }\\n\\n    .header {\\n      display: flex;\\n      flex-direction: row;\\n      align-items: center;\\n      justify-content: space-between;\\n      padding: 9px 0 17px 0;\\n    }\\n\\n    .git--button {\\n      width: 145px !important;\\n      display: flex;\\n      flex-direction: row;\\n      justify-content: center;\\n      align-items: center;\\n      padding: 8px 16px;\\n\\n      width: 154px;\\n      height: 35px;\\n\\n      background: #D4D9D4;\\n      border: 1px solid #9DAAA4;\\n      border-radius: 6px;\\n    }\\n  }\\n\\n\\n  @media only screen and (min-width: 1024px) {\\n    .guide-page-title {\\n      font-size: 46px !important;\\n    }\\n\\n    .header {\\n      padding: 9px 0 32px 0;\\n    }\\n  }\\n</style>\"\n}\n[/block]\n\n\n# Notebook Overview\n\n## Motivation\nTabular data reasoning continues to be an exciting application of Agents, particularly in the financial domain, where multiple reasoning steps may be needed to identify the right answer. For example, a financial analyst working with financial statements may be interested in computing various financial ratios with natural language queries.\n\nSome examples may include:\n- ROE (Return on Equity) = Net Income / Shareholder's Equity\n- Net Profit Margin = Net Income / Revenue\n- Asset Turnover = Revenue / Average Total Assets\n- Financial Leverage = Average Total Assets / Shareholder's Equity\n\nHaving an Agent which is able to correctly compute these and other ratios would be a great help for any analyst in the field of Finance.\n\n## Objective\nIn this notebook we explore how to setup a [Cohere ReAct Agent](https://github.com/langchain-ai/langchain-cohere/blob/main/libs/cohere/langchain_cohere/cohere_agent.py) to answer questions over tables in Apple's SEC10K 2020 form. We show how this can be done with two variants of a Langchain Python tool, one that requires you to pass the full path of the dataframe and another that requires the dataframe objects to be loaded in memory. While there is no major difference between the two approaches, we present both to show how to manage files that are loaded in memory vs files in storage. \n\n## Table of Contents\n\n- [Setup](#sec_step0)\n- [Introduction](#sec_step1)\n- [QnA over Single Table](#sec_step2)\n    - [Agent with Python Tool](#sec_step2_sub1)\n    - [Agent with Python Tool that takes tables as input](#sec_step2_sub2)\n- [QnA over Multiple Tables](#sec_step3)\n\n<a id=\"sec_step0\"></a>\n# Setup\n\n\n```python\nfrom langchain_core.pydantic_v1 import BaseModel, Field\nfrom langchain.agents import AgentExecutor\nfrom langchain_cohere.react_multi_hop.agent import create_cohere_react_agent\nfrom langchain_core.prompts import ChatPromptTemplate\nfrom langchain_cohere.chat_models import ChatCohere\nimport pandas as pd\nfrom langchain.agents import Tool\nfrom langchain_experimental.utilities import PythonREPL\nfrom langchain_experimental.tools.python.tool import PythonAstREPLTool\n```\n\n\n```python\n# Uncomment if you need to install the following packages\n#!pip install --quiet langchain langchain_cohere langchain_experimental --upgrade\n#!pip install sec-api\n```\n\n<a id=\"sec_step1\"></a>\n# Introduction\n\nThe aim of this notebook is to showcase how Cohere Langchain Agents can be used to answer questions over tabular data.\nThis notebook assumes the input is a set of csv files extracted from Apple's SEC 10K filings.\n\n### Data Loading\n\nWe use the sec-api to download the income statement and balance sheet from the SEC 10K .htm file. Please note that the tables need to be parsed such that the index is numerical as the python code generation struggles to filter based on index. We have processed the tables and provided them for you. They can be found [here](https://github.com/cohere-ai/cohere-developer-experience/tree/main/notebooks/agents/financial-csv-agent). \n\n\n```python\nincome_statement = pd.read_csv('income_statement.csv')\nbalance_sheet = pd.read_csv('balance_sheet.csv')\n```\n\n<a id=\"sec_step2\"></a>\n# QnA over Single Table \n\n<a id=\"sec_step2_sub1\"></a>\n## Agent with Python Tool\n\nIn the example below, we show how the python tool can be used to load a dataframe and extract information from it. To do this successfully we need to:\n\n* Pass the file name to the preamble so the model knows how to load the dataframe.\n* Pass a preview of the dataframe in the preamble so the model knows which columns/rows to query.\n\nFirst, let's implement the ReAct agent.\n\n\n```python\n# instantiate the Cohere llm\nllm = ChatCohere(model=\"command-r\", temperature=0.1,cohere_api_key=\"\",verbose=True)\n\n# create the python tool\npython_repl = PythonREPL()\npython_tool = Tool(\n    name=\"python_repl\",\n    description=\"Executes python code and returns the result. The code runs in a static sandbox without interactive mode, so print output or save output to a file.\",\n    func=python_repl.run,\n)\npython_tool.name = \"python_interpreter\"\n\nclass ToolInput(BaseModel):\n    code: str = Field(description=\"Python code to execute.\")\npython_tool.args_schema = ToolInput\ntools=[python_tool]\n\n# define the prompt template\nprompt = ChatPromptTemplate.from_template(\"{input}\")\n\n# instantiate the ReAct agent\nagent = create_cohere_react_agent(\n   llm=llm,\n   tools=tools,\n   prompt=prompt,\n)\nagent_executor = AgentExecutor(agent=agent,\n                               tools=tools,\n                               verbose=True,\n                               return_intermediate_steps=True\n                    )\n# finally, define the preamble\npreamble = \"\"\"\nYou are an expert who answers the user's question. You are working with a pandas dataframe in Python. The name of the dataframe is `income_statement.csv`.\nHere is a preview of the dataframe:\n{head_df}\n\"\"\".format(head_df=income_statement.head(3).to_markdown())\n\n```\n\nThen, we define the dictionary including the questions we want the Agent to answer, and their answer.\n\n\n```python\nquestion_dict ={\n    'q1': ['what is the highest value of cost of goods and service?',169559000000],\n    'q2': ['what is the largest gross profit margin?',0.3836194330595236],\n    'q3': ['what is the minimum ratio of operating income loss divided by non operating income expense',35.360599]\n}\n```\n\nLet's now see how the Agent answers each of the questions.\n\n\n```python\nfor qsn,val in question_dict.items():\n    print(f'question:{qsn}')\n    agent_executor.invoke({\n       \"input\": val[0],\n       \"preamble\": preamble,\n    })\n    print(f'GT Answer:{val[1]}')\n    print('-'*50)\n```\n\n    question:q1\n    \n    \n    \u001b[1m> Entering new AgentExecutor chain...\u001b[0m\n    \u001b[32;1m\u001b[1;3m\n    I will write and execute Python code to find the highest value of Cost of Goods and Services Sold from the provided dataframe.\n    {'tool_name': 'python_interpreter', 'parameters': {'code': 'import pandas as pd\\n\\n# Read the CSV file into a DataFrame\\ndf = pd.read_csv(\\'income_statement.csv\\')\\n\\n# Find the highest value in the \\'CostOfGoodsAndServicesSold\\' column\\nmax_value = df[\\'CostOfGoodsAndServicesSold\\'].max()\\n\\nprint(f\"The highest value of Cost of Goods and Services Sold is {max_value}\")'}}\n    \u001b[0m\u001b[36;1m\u001b[1;3mThe highest value of Cost of Goods and Services Sold is 169559000000.0\n    \u001b[0m\u001b[32;1m\u001b[1;3mRelevant Documents: 0\n    Cited Documents: 0\n    Answer: The highest value of Cost of Goods and Services Sold is 169559000000.0.\n    Grounded answer: The highest value of Cost of Goods and Services Sold is <co: 0>169559000000.0</co: 0>.\u001b[0m\n    \n    \u001b[1m> Finished chain.\u001b[0m\n    GT Answer:169559000000\n    --------------------------------------------------\n    question:q2\n    \n    \n    \u001b[1m> Entering new AgentExecutor chain...\u001b[0m\n    \u001b[32;1m\u001b[1;3m\n    I will write and execute Python code to calculate the largest gross profit margin from the data frame provided.\n    {'tool_name': 'python_interpreter', 'parameters': {'code': 'import pandas as pd\\n\\n# Read the CSV file into a DataFrame\\ndf = pd.read_csv(\\'income_statement.csv\\')\\n\\n# Calculate the gross profit margin as a percentage\\ndf[\\'GrossProfitMargin\\'] = (df[\\'GrossProfit\\'] / df[\\'RevenueFromContractWithCustomerExcludingAssessedTax\\']) * 100\\n\\n# Find the row with the maximum gross profit margin\\nmax_margin_row = df.loc[df[\\'GrossProfitMargin\\'].idxmax()]\\n\\nprint(f\"The largest gross profit margin is {max_margin_row[\\'GrossProfitMargin\\']}% on {max_margin_row[\\'index\\']}\")\\n'}}\n    \u001b[0m\u001b[36;1m\u001b[1;3mThe largest gross profit margin is 38.36194330595236% on 2019-12-29-2020-03-28\n    \u001b[0m\u001b[32;1m\u001b[1;3mRelevant Documents: 0\n    Cited Documents: 0\n    Answer: The largest gross profit margin is approximately 38.36% on 2019-12-29 to 2020-03-28.\n    Grounded answer: The largest gross profit margin is <co: 0>approximately 38.36</co: 0>% on <co: 0>2019-12-29 to 2020-03-28</co: 0>.\u001b[0m\n    \n    \u001b[1m> Finished chain.\u001b[0m\n    GT Answer:0.3836194330595236\n    --------------------------------------------------\n    question:q3\n    \n    \n    \u001b[1m> Entering new AgentExecutor chain...\u001b[0m\n    \u001b[32;1m\u001b[1;3m\n    I will write and execute Python code to calculate the minimum ratio of Operating Income Loss divided by Non Operating Income Expense.\n    {'tool_name': 'python_interpreter', 'parameters': {'code': 'import pandas as pd\\n\\n# Read the CSV file into a DataFrame\\ndf = pd.read_csv(\\'income_statement.csv\\')\\n\\n# Calculate the ratio\\nratios = df[\\'OperatingIncomeLoss\\'] / df[\\'NonoperatingIncomeExpense\\']\\n\\nprint(\"Minimum ratio:\", ratios.min())'}}\n    \u001b[0m\u001b[36;1m\u001b[1;3mMinimum ratio: 35.36059850374065\n    \u001b[0m\u001b[32;1m\u001b[1;3mRelevant Documents: 0\n    Cited Documents: 0\n    Answer: The minimum ratio of Operating Income Loss divided by Non Operating Income Expense is approximately **35.36**.\n    Grounded answer: The minimum ratio of Operating Income Loss divided by Non Operating Income Expense is approximately *<co: 0>*35.36</co: 0>**.\u001b[0m\n    \n    \u001b[1m> Finished chain.\u001b[0m\n    GT Answer:35.360599\n    --------------------------------------------------\n\n\nNice! The agent uses the Python tool to write the code to access the data in the tables, and perform the required calculations.\n\n<a id=\"sec_step2_sub2\"></a>\n## Agent with Python Tool that takes tables as input\n\nIn the example above, the model needs to load the dataframe in the python call before carrying out operations. In this example, we show how to pass the dataframes to the python tool so it has the file already loaded.\n\n\n```python\n# call the PythonAstREPLTool in order to pass tables to the tool\ndf_locals = {'df':pd.read_csv('income_statement.csv')}\ntools = [PythonAstREPLTool(locals=df_locals)]\n\nagent = create_cohere_react_agent(\n   llm=llm,\n   tools=tools,\n   prompt=prompt,\n)\nagent_executor = AgentExecutor(agent=agent,\n                               tools=tools,\n                               verbose=True,\n                               return_intermediate_steps=True\n                    )\n\npreamble = \"\"\"\nYou are an expert who answers the user's question. You are working with a pandas dataframe in Python. The name of the dataframe is `df`.\nHere is a preview of the dataframe:\n{head_df}\n\"\"\".format(head_df=income_statement.head(3).to_markdown())\n\n```\n\nLet's loop again over the same dictionary of questions.\n\n\n```python\nfor qsn,val in question_dict.items():\n    print(f'question:{qsn}')\n    agent_executor.invoke({\n       \"input\": val[0],\n       \"preamble\": preamble,\n    })\n    print(f'GT Answer:{val[1]}')\n    print('-'*50)\n```\n\n    question:q1\n    \n    \n    \u001b[1m> Entering new AgentExecutor chain...\u001b[0m\n    \u001b[32;1m\u001b[1;3m\n    I will write and execute Python code to find the highest value of Cost of Goods and Services Sold from the provided dataframe.\n    {'tool_name': 'python_interpreter', 'parameters': {'code': \"import pandas as pd\\n\\n# Read the CSV file into a DataFrame\\ndf = pd.read_csv('income_statement.csv')\\n\\n# Find the highest value in the 'CostOfGoodsAndServicesSold' column\\nmax_value = df['CostOfGoodsAndServicesSold'].max()\\n\\nprint(f'The highest value of Cost of Goods and Services Sold is {max_value:.2f}')\\n\"}}\n    \u001b[0m\u001b[36;1m\u001b[1;3mThe highest value of Cost of Goods and Services Sold is 169559000000.00\n    \u001b[0m\u001b[32;1m\u001b[1;3mRelevant Documents: 0\n    Cited Documents: 0\n    Answer: The highest value of Cost of Goods and Services Sold is 169559000000.00.\n    Grounded answer: The highest value of Cost of Goods and Services Sold is <co: 0>169559000000.00</co: 0>.\u001b[0m\n    \n    \u001b[1m> Finished chain.\u001b[0m\n    GT Answer:169559000000\n    --------------------------------------------------\n    question:q2\n    \n    \n    \u001b[1m> Entering new AgentExecutor chain...\u001b[0m\n    \u001b[32;1m\u001b[1;3m\n    I will write and execute Python code to calculate the largest gross profit margin from the data frame provided.\n    {'tool_name': 'python_interpreter', 'parameters': {'code': 'import pandas as pd\\n\\n# Read the CSV file into a DataFrame\\ndf = pd.read_csv(\\'income_statement.csv\\')\\n\\n# Calculate the gross profit margin as a percentage\\ndf[\\'GrossProfitMargin\\'] = (df[\\'GrossProfit\\'] / df[\\'RevenueFromContractWithCustomerExcludingAssessedTax\\']) * 100\\n\\n# Find the row with the maximum gross profit margin\\nmax_margin_row = df.loc[df[\\'GrossProfitMargin\\'].idxmax()]\\n\\nprint(f\"The largest gross profit margin is {max_margin_row[\\'GrossProfitMargin\\']}% on {max_margin_row[\\'index\\']}\")\\n'}}\n    \u001b[0m\u001b[36;1m\u001b[1;3mThe largest gross profit margin is 38.36194330595236% on 2019-12-29-2020-03-28\n    \u001b[0m\u001b[32;1m\u001b[1;3mRelevant Documents: 0\n    Cited Documents: 0\n    Answer: The largest gross profit margin is approximately 38.36% on 2019-12-29 to 2020-03-28.\n    Grounded answer: The largest gross profit margin is <co: 0>approximately 38.36</co: 0>% on <co: 0>2019-12-29 to 2020-03-28</co: 0>.\u001b[0m\n    \n    \u001b[1m> Finished chain.\u001b[0m\n    GT Answer:0.3836194330595236\n    --------------------------------------------------\n    question:q3\n    \n    \n    \u001b[1m> Entering new AgentExecutor chain...\u001b[0m\n    \u001b[32;1m\u001b[1;3m\n    I will write and execute Python code to calculate the minimum ratio of Operating Income Loss divided by Non Operating Income Expense.\n    {'tool_name': 'python_interpreter', 'parameters': {'code': \"import pandas as pd\\n\\n# Read the CSV file into a DataFrame\\ndf = pd.read_csv('income_statement.csv')\\n\\n# Calculate the ratio\\nratios = df['OperatingIncomeLoss'] / df['NonoperatingIncomeExpense']\\n\\n# Find the minimum ratio\\nmin_ratio = ratios.min()\\n\\nprint(f'Minimum ratio: {min_ratio:.2f}')\\n\"}}\n    \u001b[0m\u001b[36;1m\u001b[1;3mMinimum ratio: 35.36\n    \u001b[0m\u001b[32;1m\u001b[1;3mRelevant Documents: 0\n    Cited Documents: 0\n    Answer: The minimum ratio of Operating Income Loss divided by Non Operating Income Expense is approximately **35.36**.\n    Grounded answer: The minimum ratio of Operating Income Loss divided by Non Operating Income Expense is approximately *<co: 0>*35.36</co: 0>**.\u001b[0m\n    \n    \u001b[1m> Finished chain.\u001b[0m\n    GT Answer:35.360599\n    --------------------------------------------------\n\n\nAlso in this case, the Agent correctly answers all the questions.\n\n<a id=\"sec_step3\"></a>\n# QnA over Multiple Tables\n\nWe now make the task for the Agent more complicated, by asking it questions whose answer can be computed only by retrieving relevant information from multiple tables.\n\n\n```python\n# define the Agent\npython_repl = PythonREPL()\npython_tool = Tool(\n    name=\"python_repl\",\n    description=\"Executes python code and returns the result. The code runs in a static sandbox without interactive mode, so print output or save output to a file.\",\n    func=python_repl.run,\n)\npython_tool.name = \"python_interpreter\"\n\nclass ToolInput(BaseModel):\n    code: str = Field(description=\"Python code to execute.\")\npython_tool.args_schema = ToolInput\ntools=[python_tool]\n\nprompt = ChatPromptTemplate.from_template(\"{input}\")\nagent = create_cohere_react_agent(\n   llm=llm,\n   tools=tools,\n   prompt=prompt,\n)\nagent_executor = AgentExecutor(agent=agent,\n                               tools=tools,\n                               verbose=True,\n                               return_intermediate_steps=True\n                    )\n\npreamble = \"\"\"\nYou are an expert who answers the user's question in complete sentences. You are working with two pandas dataframe in Python. Ensure your output is a string.\n\nHere is a preview of the `income_statement.csv` dataframe:\n{table_1}\n\nHere is a preview of the `balance_sheet.csv` dataframe:\n{table_2}\n\"\"\".format(table_1=income_statement.head(3).to_markdown(),table_2=balance_sheet.head(3).to_markdown())\n\n```\n\nWe now define a new question.\n\n\n```python\nquestion_dict ={\n    'q1': ['what is the ratio of the largest stockholders equity to the smallest revenue'],\n}\n```\n\nThe answer to this question can be obtained only by accessing both the balance sheet and the income statement, as shown below:\n\n\n```python\n# get the largest stockholders equity\nx = balance_sheet['StockholdersEquity'].astype(float).max()\nprint(f\"The largest stockholders equity value is: {x}\")\n\n# get the smallest revenue\ny = income_statement['RevenueFromContractWithCustomerExcludingAssessedTax'].astype(float).min()\nprint(f\"The smallest revenue value is: {y}\")\n\n# compute the ratio\nratio = x/y\nprint(f\"Their ratio is: {ratio}\")\n```\n\n    The largest stockholders equity value is: 134047000000.0\n    The smallest revenue value is: 53809000000.0\n    Their ratio is: 2.4911631883142227\n\n\nLet's now get the answer from the Agent.\n\n\n```python\nfor qsn,val in question_dict.items():\n    print(f'question:{qsn}')\n    agent_executor.invoke({\n       \"input\": val[0],\n       \"preamble\": preamble,\n    })\n```\n\n    question:q1\n    \n    \n    \u001b[1m> Entering new AgentExecutor chain...\u001b[0m\n    \u001b[32;1m\u001b[1;3m\n    I will write and execute Python code to find the largest and smallest values in the relevant columns of the dataframes, then calculate the ratio.\n    {'tool_name': 'python_interpreter', 'parameters': {'code': \"import pandas as pd\\n\\nincome_statement = pd.read_csv('income_statement.csv')\\nbalance_sheet = pd.read_csv('balance_sheet.csv')\\n\\n# Find largest and smallest values in relevant columns\\nmax_stockholders_equity = max([balance_sheet['StockholdersEquity'].iloc[i] for i in range(len(balance_sheet))])\\nmin_revenue = min([income_statement['RevenueFromContractWithCustomerExcludingAssessedTax'].iloc[i] for i in range(len(income_statement))])\\n\\n# Calculate ratio\\nratio = max_stockholders_equity / min_revenue\\n\\nprint(f'The ratio of the largest stockholders equity to the smallest revenue is {ratio:.2f}'\\n    )\"}}\n    \u001b[0m\u001b[36;1m\u001b[1;3mNameError(\"name 'balance_sheet' is not defined\")\u001b[0m\u001b[32;1m\u001b[1;3m\n    My code has thrown an error because the variable `balance_sheet` has not been defined. I will fix this by adding the line `balance_sheet = pd.read_csv('balance_sheet.csv')` to the beginning of my code.\n    {'tool_name': 'python_interpreter', 'parameters': {'code': \"import pandas as pd\\n\\nincome_statement = pd.read_csv('income_statement.csv')\\n\\nbalance_sheet = pd.read_csv('balance_sheet.csv')\\n\\n# Find largest and smallest values in relevant columns\\nmax_stockholders_equity = max([balance_sheet['StockholdersEquity'].iloc[i] for i in range(len(balance_sheet))])\\nmin_revenue = min([income_statement['RevenueFromContractWithCustomerExcludingAssessedTax'].iloc[i] for i in range(len(income_statement))])\\n\\n# Calculate ratio\\nratio = max_stockholders_equity / min_revenue\\n\\nprint(f'The ratio of the largest stockholders equity to the smallest revenue is {ratio:.2f}'\\n    )\"}}\n    \u001b[0m\u001b[36;1m\u001b[1;3mNameError(\"name 'balance_sheet' is not defined\")\u001b[0m\u001b[32;1m\u001b[1;3m\n    The same error has occurred again, so I will check my code carefully to make sure the variable is being defined correctly.\n    {'tool_name': 'python_interpreter', 'parameters': {'code': \"import pandas as pd\\n\\n# Load data\\nincome_statement = pd.read_csv('income_statement.csv')\\nbalance_sheet = pd.read_csv('balance_sheet.csv')\\n\\n# Find largest and smallest values in relevant columns\\nmax_stockholders_equity = max(balance_sheet['StockholdersEquity'])\\nmin_revenue = min(income_statement['RevenueFromContractWithCustomerExcludingAssessedTax'])\\n\\n# Calculate ratio\\nratio = max_stockholders_equity / min_revenue\\n\\nprint(f'The ratio of the largest stockholders equity to the smallest revenue is {ratio:.2f}')\"}}\n    \u001b[0m\u001b[36;1m\u001b[1;3mThe ratio of the largest stockholders equity to the smallest revenue is 2.49\n    \u001b[0m\u001b[32;1m\u001b[1;3mRelevant Documents: 0,1,2\n    Cited Documents: 2\n    Answer: The ratio of the largest stockholders equity to the smallest revenue is approximately **2.49**.\n    Grounded answer: The ratio of the largest stockholders equity to the smallest revenue is approximately *<co: 2>*2.49</co: 2>**.\u001b[0m\n    \n    \u001b[1m> Finished chain.\u001b[0m\n\n\nThe Agent defined a plan (\"write and execute Python code to find the largest and smallest values in the relevant columns of the dataframes, then calculate the ratio\") and executed it. It made some mistakes when coding, that resulted in NameError errors, but it fixed them and finally got to the correct answer",
    "html": "",
    "htmlmode": false,
    "fullscreen": false,
    "hidden": true,
    "revision": 8,
    "_id": "66575a442498500010e6862f",
    "__v": 0,
    "createdAt": "2024-05-29T16:39:32.900Z",
    "lastUpdatedHash": "59691455adba5771448b6664ac673245d75af00f",
    "project": "62cde2919aafea009aefb289",
    "updatedAt": "2024-07-11T01:20:29.397Z",
    "user": "5af39863989da435b05d284e"
  },
  "meta": {
    "user": {
      "allowedProjects": ["cohere-ai", "cohere-enterprise"],
      "apiKey": "",
      "email": "andrewjiang@hey.com",
      "name": "Andrew Jiang",
      "version": 1,
      "Name": "Andrew Jiang",
      "Email": "andrewjiang@hey.com",
      "APIKey": "",
      "AllowedProjects": ["cohere-ai", "cohere-enterprise"]
    },
    "baseUrl": "/",
    "hidden": true,
    "title": "Financial CSV Agent with Langchain",
    "metaTitle": "Financial CSV Agent with Langchain",
    "keywords": "",
    "description": "",
    "image": [],
    "slug": "csv-agent",
    "type": "custompage",
    "full": false
  }
}
